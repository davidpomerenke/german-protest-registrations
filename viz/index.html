<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>German Protest Registrations - Interactive Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafafa;
            color: #333;
        }

        .header {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #666;
            font-size: 0.95rem;
        }

        .controls {
            background: #fff;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 0.9rem;
            background: #fff;
            transition: border-color 0.2s;
        }

        select:hover, input:hover {
            border-color: #007bff;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .main-content {
            display: flex;
            height: calc(100vh - 200px);
        }

        #visualization {
            flex: 1;
            background: #fff;
            margin: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }

        .sidebar {
            width: 350px;
            background: #fff;
            margin: 1rem 1rem 1rem 0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-y: auto;
            padding: 1.5rem;
        }

        .sidebar h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #1a1a1a;
        }

        .event-detail {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .event-detail strong {
            color: #555;
            display: inline-block;
            min-width: 100px;
        }

        .event-detail p {
            margin-bottom: 0.75rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 0.25rem 0.25rem 0 0;
        }

        .node {
            cursor: pointer;
            transition: all 0.2s;
        }

        .node:hover {
            stroke: #007bff;
            stroke-width: 3px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: #666;
        }

        .stats {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
        }

        .stat-value {
            font-weight: 700;
            color: #007bff;
        }

        .link {
            color: #007bff;
            text-decoration: none;
            border-bottom: 1px dotted #007bff;
        }

        .link:hover {
            border-bottom-style: solid;
        }

        button {
            padding: 0.5rem 1rem;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background: #0056b3;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-toggle button {
            background: #fff;
            color: #666;
            border: 1px solid #d0d0d0;
        }

        .view-toggle button.active {
            background: #007bff;
            color: #fff;
            border-color: #007bff;
        }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                margin: 0 1rem 1rem 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>German Protest Registrations</h1>
        <p class="subtitle">Interactive visualization of 70,000+ demonstrations across 17 German cities (2012-2024)</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="view-mode">View Mode</label>
            <div class="view-toggle">
                <button id="view-overall" class="active" onclick="setViewMode('overall')">Overall</button>
                <button id="view-city" onclick="setViewMode('city')">By City</button>
                <button id="view-topic" onclick="setViewMode('topic')">By Topic</button>
            </div>
        </div>

        <div class="control-group">
            <label for="city-filter">Filter by City</label>
            <select id="city-filter" onchange="updateVisualization()">
                <option value="">All Cities</option>
            </select>
        </div>

        <div class="control-group">
            <label for="topic-filter">Filter by Topic</label>
            <input type="text" id="topic-filter" placeholder="Search topics..." oninput="updateVisualization()">
        </div>

        <div class="control-group">
            <label for="year-filter">Year Range</label>
            <input type="range" id="year-start" min="2012" max="2024" value="2012" oninput="updateVisualization()">
            <span id="year-range-display">2012-2024</span>
            <input type="range" id="year-end" min="2012" max="2024" value="2024" oninput="updateVisualization()">
        </div>
    </div>

    <div class="main-content">
        <div id="visualization">
            <div class="loading">Loading data...</div>
        </div>
        <div class="sidebar">
            <div class="stats">
                <h3>Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span>Total Events:</span>
                        <span class="stat-value" id="stat-total">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Cities:</span>
                        <span class="stat-value" id="stat-cities">17</span>
                    </div>
                    <div class="stat-item">
                        <span>Date Range:</span>
                        <span class="stat-value" id="stat-years">2012-2024</span>
                    </div>
                    <div class="stat-item">
                        <span>Filtered:</span>
                        <span class="stat-value" id="stat-filtered">0</span>
                    </div>
                </div>
            </div>

            <div class="event-detail" id="event-detail">
                <h3>Event Details</h3>
                <p style="color: #999;">Click on any protest to see details</p>
            </div>

            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e0e0e0;">
                <h3>About</h3>
                <p style="font-size: 0.85rem; line-height: 1.6; color: #666;">
                    This dataset leverages Freedom of Information laws to collect official protest data from 17 cities in Germany.
                    Data compiled from demonstration authorities via <a href="https://fragdenstaat.de" class="link" target="_blank">FragDenStaat</a>.
                </p>
                <p style="font-size: 0.85rem; margin-top: 0.75rem;">
                    <a href="https://github.com/davidpomerenke/german-protest-registrations" class="link" target="_blank">View on GitHub</a> |
                    <a href="https://zenodo.org/records/10094245" class="link" target="_blank">Dataset (Zenodo)</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let data = [];
        let filteredData = [];
        let viewMode = 'overall';
        let svg, simulation;

        // Initialize
        async function init() {
            try {
                // Load the dataset
                data = await d3.csv('data.csv');

                // Parse dates
                data.forEach(d => {
                    d.date = new Date(d.date);
                    d.year = d.date.getFullYear();
                });

                // Populate city filter
                const cities = [...new Set(data.map(d => d.city))].sort();
                const citySelect = d3.select('#city-filter');
                cities.forEach(city => {
                    citySelect.append('option').text(city).attr('value', city);
                });

                // Update stats
                document.getElementById('stat-total').textContent = data.length.toLocaleString();

                // Initial visualization
                updateVisualization();
            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelector('.loading').textContent = 'Error loading data. Please check console for details.';
            }
        }

        function setViewMode(mode) {
            viewMode = mode;
            document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`view-${mode}`).classList.add('active');
            updateVisualization();
        }

        function updateVisualization() {
            // Apply filters
            const cityFilter = document.getElementById('city-filter').value;
            const topicFilter = document.getElementById('topic-filter').value.toLowerCase();
            const yearStart = parseInt(document.getElementById('year-start').value);
            const yearEnd = parseInt(document.getElementById('year-end').value);

            filteredData = data.filter(d => {
                if (cityFilter && d.city !== cityFilter) return false;
                if (topicFilter && !d.topic?.toLowerCase().includes(topicFilter)) return false;
                if (d.year < yearStart || d.year > yearEnd) return false;
                return true;
            });

            // Update stats
            document.getElementById('stat-filtered').textContent = filteredData.length.toLocaleString();
            document.getElementById('stat-years').textContent = `${yearStart}-${yearEnd}`;

            // Render visualization
            renderVisualization();
        }

        function renderVisualization() {
            const container = document.getElementById('visualization');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Clear existing
            d3.select('#visualization svg').remove();

            // Create SVG
            svg = d3.select('#visualization')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Sample data for performance (show up to 5000 events)
            const displayData = filteredData.length > 5000
                ? filteredData.slice(0, 5000)
                : filteredData;

            // Create nodes
            const nodes = displayData.map((d, i) => ({
                id: i,
                data: d,
                x: Math.random() * width,
                y: Math.random() * height,
                r: 3 + Math.random() * 4
            }));

            // Create force simulation
            simulation = d3.forceSimulation(nodes)
                .force('charge', d3.forceManyBody().strength(-5))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => d.r + 1));

            // Create tooltip
            const tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);

            // Draw nodes
            const node = svg.selectAll('.node')
                .data(nodes)
                .enter()
                .append('circle')
                .attr('class', 'node')
                .attr('r', d => d.r)
                .attr('fill', d => {
                    // Color by city or topic based on view mode
                    if (viewMode === 'city') {
                        return d3.scaleOrdinal(d3.schemeCategory10)(d.data.city);
                    } else if (viewMode === 'topic') {
                        return d3.scaleOrdinal(d3.schemeTableau10)(d.data.topic?.substring(0, 20) || 'Unknown');
                    } else {
                        return d3.interpolateBlues(d.data.year / 2024);
                    }
                })
                .attr('opacity', 0.7)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('stroke', '#007bff').attr('stroke-width', 2);
                    tooltip.transition().duration(200).style('opacity', 1);
                    tooltip.html(`
                        <strong>${d.data.city}</strong><br>
                        ${d.data.date.toLocaleDateString()}<br>
                        ${(d.data.topic || 'No topic').substring(0, 100)}...
                    `)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('stroke', null);
                    tooltip.transition().duration(500).style('opacity', 0);
                })
                .on('click', function(event, d) {
                    showEventDetail(d.data);
                });

            // Update positions on tick
            simulation.on('tick', () => {
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
            });

            // Clear loading message
            d3.select('.loading').style('display', 'none');
        }

        function showEventDetail(event) {
            const detail = document.getElementById('event-detail');
            detail.innerHTML = `
                <h3>Event Details</h3>
                <p><strong>City:</strong> ${event.city}</p>
                <p><strong>Date:</strong> ${event.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                <p><strong>Topic:</strong> ${event.topic || 'Not specified'}</p>
                ${event.organizer ? `<p><strong>Organizer:</strong> ${event.organizer}</p>` : ''}
                ${event.participants_registered ? `<p><strong>Registered:</strong> ${event.participants_registered} participants</p>` : ''}
                ${event.participants_actual ? `<p><strong>Actual:</strong> ${event.participants_actual} participants</p>` : ''}
                <p style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0; font-size: 0.85rem;">
                    <a href="https://github.com/davidpomerenke/german-protest-registrations/tree/main/data/processed" class="link" target="_blank">View source data</a>
                </p>
            `;
        }

        // Initialize on load
        init();

        // Handle window resize
        window.addEventListener('resize', () => {
            if (filteredData.length > 0) {
                updateVisualization();
            }
        });
    </script>
</body>
</html>
